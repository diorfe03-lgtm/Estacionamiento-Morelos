<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Estacionamiento</title>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<style>
body { background:#1e3c72; padding:20px; font-family:sans-serif; }
.app { background:#fff; max-width:420px; margin:auto; padding:20px; border-radius:16px; }
.hidden { display:none; }
.total { font-size:20px; font-weight:bold; color:green; }
input,button { width:100%; padding:12px; margin:6px 0; }
</style>
</head>

<body>
<div class="app">
<h2>ðŸš— Estacionamiento</h2>

<button onclick="showNew()">Nuevo boleto</button>
<button onclick="showPay()">Cobrar</button>

<div id="newTicket" class="hidden">
  <input id="placas" placeholder="Placas *">
  <input id="marca" placeholder="Marca">
  <input id="modelo" placeholder="Modelo">
  <input id="color" placeholder="Color">
  <button onclick="createTicket()">Imprimir</button>
</div>

<div id="payTicket" class="hidden">
  <input id="qrId" placeholder="ID QR">
  <button onclick="scanQr()">Buscar</button>
  <div id="chargeInfo"></div>
  <label><input type="checkbox" id="confirmPaid"> Cobrado</label>
  <button onclick="confirmPayment()">Confirmar</button>
</div>
</div>

<script>
const API = location.origin;

function limpiarNuevo() {
  placas.value = marca.value = modelo.value = color.value = "";
}

function limpiarCobro() {
  qrId.value = "";
  chargeInfo.innerHTML = "";
  confirmPaid.checked = false;
}

function showNew() {
  limpiarNuevo();
  limpiarCobro();
  newTicket.classList.remove("hidden");
  payTicket.classList.add("hidden");
}

function showPay() {
  limpiarNuevo();
  limpiarCobro();
  payTicket.classList.remove("hidden");
  newTicket.classList.add("hidden");
}

async function createTicket() {
  if (!placas.value.trim()) return alert("Placas obligatorias");

  const res = await fetch(API + "/ticket", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      placas: placas.value,
      marca: marca.value,
      modelo: modelo.value,
      color: color.value
    })
  });

  const { id } = await res.json();

  const win = window.open("", "", "width=300,height=500");
  win.document.write(`
    <h3>Estacionamiento Morelos</h3>
    <canvas id="qr"></canvas>
    <p>Placas: ${placas.value}</p>
    <p>Marca: ${marca.value || "----"}</p>
    <p>Modelo: ${modelo.value || "----"}</p>
    <p>Color: ${color.value || "----"}</p>
  `);

  QRCode.toCanvas(win.document.getElementById("qr"), id, () => {
    win.print();
    win.close();
  });

  limpiarNuevo();
}

async function scanQr() {
  const r = await fetch(API + "/ticket/" + qrId.value);
  const d = await r.json();

  if (d.error) return chargeInfo.innerText = d.error;

  chargeInfo.innerHTML = `
    <p>Placas: ${d.placas}</p>
    <p>Hora entrada: ${d.horaEntrada}</p>
    <div class="total">$${d.monto}</div>
  `;
}

async function confirmPayment() {
  if (!confirmPaid.checked) return alert("Marca cobrado");

  const r = await fetch(API + "/pay/" + qrId.value, { method:"POST" });
  const d = await r.json();

  alert(
    `Placas: ${d.placas}\n` +
    `Entrada: ${d.horaEntrada}\n` +
    `Salida: ${d.horaSalida}\n` +
    `Total: $${d.monto}`
  );

  limpiarCobro();
}
</script>
</body>
</html>
