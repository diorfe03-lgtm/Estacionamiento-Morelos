<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Estacionamiento Pro</title>

<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
  body { font-family: system-ui, sans-serif; background: linear-gradient(135deg, #1e3c72, #2a5298); margin: 0; padding: 20px; }
  .app { max-width: 420px; margin: auto; background: #fff; border-radius: 16px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
  h2 { text-align: center; color:#2a5298; }
  button { width: 100%; padding: 14px; margin: 10px 0; border-radius: 12px; border: none; font-size: 16px; cursor: pointer; font-weight: bold; }
  .primary { background:#2a5298; color:white; }
  .secondary { background:#f1f5f9; color: #1e3c72; }
  .success { background:#16a34a; color:white; }
  .warning { background:#fef08a; color: #854d0e; }
  input { width:100%; padding:12px; margin:6px 0; border-radius:10px; border:1px solid #ccc; box-sizing: border-box; font-size: 16px; }
  .card { background:#f8fafc; padding:15px; border-radius:12px; margin-top:15px; border: 1px solid #e2e8f0; }
  .hidden { display:none; }
  .total { font-size:28px; color:#16a34a; font-weight:bold; }
  #reader { width: 100%; border-radius: 12px; overflow: hidden; margin-top: 10px; }
</style>
</head>
<body>
<div class="app">
  <h2>ðŸš— Estacionamiento</h2>
  
  <button class="primary" onclick="showNew()">Nuevo boleto</button>
  <button class="secondary" onclick="showPay()">Cobrar Boleto</button>

  <div id="newTicket" class="card hidden">
    <input placeholder="Placas (Obligatorio)" id="placas">
    <input placeholder="Marca" id="marca">
    <input placeholder="Modelo" id="modelo">
    <input placeholder="Color" id="color">
    <button class="primary" onclick="createTicket()">Imprimir Ticket Directo</button>
  </div>

  <div id="payTicket" class="card hidden">
    <button class="warning" onclick="startScanner()">ðŸ“· Escanear CÃ³digo QR</button>
    <div id="reader" class="hidden"></div>
    
    <input placeholder="ID del Boleto" id="qrId">
    <button class="secondary" onclick="scanQr()">Buscar Datos</button>
    
    <div id="chargeInfo" class="info-pago"></div>
    
    <div id="confirmArea" class="hidden">
      <label style="display:block; margin: 15px 0; font-size: 18px;"><input type="checkbox" id="confirmPaid"> Confirmar Pago</label>
      <button class="success" onclick="confirmPayment()">Finalizar Cobro</button>
    </div>
  </div>

  <div style="margin-top: 30px; border-top: 2px dashed #e2e8f0; padding-top: 10px;">
    <button style="font-size: 13px;" class="secondary" onclick="toggleCorte()">ðŸ“Š Reporte del DÃ­a</button>
    <div id="corteSection" class="card hidden">
      <input type="password" id="adminPass" placeholder="ContraseÃ±a">
      <button class="primary" onclick="obtenerCorte()">Consultar Caja</button>
      <div id="corteResultado"></div>
    </div>
  </div>
</div>

<script>
const API = window.location.origin;
let html5QrCode;

// --- LÃ“GICA DE IMPRESIÃ“N (CORREGIDA PARA RAWBT) ---
function enviarARawBT(id, info) {
    const fechaActual = new Date().toLocaleString('es-MX', { 
        hour: '2-digit', minute: '2-digit', day: '2-digit', 
        month: '2-digit', year: 'numeric', hour12: true 
    });

    const tempDiv = document.createElement('div');
    tempDiv.style.width = '300px'; // Un poco mÃ¡s estrecho para evitar recortes
    tempDiv.style.position = 'absolute';
    tempDiv.style.left = '-9999px';
    tempDiv.style.background = 'white';
    tempDiv.style.padding = '10px';
    
    tempDiv.innerHTML = `
        <div style="text-align: center; color: black; font-family: monospace; background: white; width: 100%;">
            <b style="font-size: 18px;">ESTACIONAMIENTO</b><br>
            <b style="font-size: 18px;">MORELOS 322</b><br>
            <span style="font-size: 12px;">Comalcalco, Tabasco</span><br>
            
            <div id="qr-final" style="margin: 5px auto; display: inline-block;"></div><br>
            
            <div style="border-top: 2px solid black; border-bottom: 2px solid black; margin: 5px 0; padding: 5px;">
                <span style="font-size: 14px;">PLACAS:</span><br>
                <b style="font-size: 38px; line-height: 1;">${info.placas.toUpperCase()}</b>
            </div>
            
            <div style="text-align: left; font-size: 14px; line-height: 1.2;">
                MARCA: ${info.marca || '---'}<br>
                MODELO: ${info.modelo || '---'}<br>
                COLOR: ${info.color || '---'}<br>
                ENTRADA: ${fechaActual}
            </div>
            
            <div style="border: 1px solid black; margin: 8px 0; padding: 5px; font-weight: bold; font-size: 14px;">
                HORARIO: 8:30 AM A 7:30 PM
            </div>
            
            <p style="font-size: 10px; text-align: justify; margin: 5px 0;">
                No nos hacemos responsables por robo total o parcial, ni por objetos de valor.
            </p>
            <b>CONSERVE SU BOLETO</b>
        </div>
    `;
    document.body.appendChild(tempDiv);

    // Generar QR
    new QRCode(tempDiv.querySelector('#qr-final'), {
        text: id, width: 140, height: 140
    });

    setTimeout(() => {
        html2canvas(tempDiv, { 
            scale: 1.5, // Reducimos escala para que el base64 sea corto
            backgroundColor: "#ffffff",
            logging: false
        }).then(canvas => {
            // Generamos PNG
            const imgData = canvas.toDataURL("image/png");
            
            // LIMPIEZA AGRESIVA: Solo caracteres vÃ¡lidos de Base64
            // Esto elimina cualquier encabezado, espacio, o salto de lÃ­nea
            const rawBase64 = imgData.split(',')[1].replace(/[^A-Za-z0-9+/=]/g, "");
            
            const rawbtUrl = "rawbt:data:image/png;base64," + rawBase64 + "&auto=1";
            
            // Abrir directamente
            window.location.href = rawbtUrl;
            
            document.body.removeChild(tempDiv);
        });
    }, 700);
}

// --- FUNCIONES DE LA APP ---

function startScanner() {
  document.getElementById("reader").classList.remove("hidden");
  html5QrCode = new Html5Qrcode("reader");
  html5QrCode.start(
    { facingMode: "environment" }, 
    { fps: 15, qrbox: { width: 250, height: 250 } },
    (decodedText) => {
      document.getElementById("qrId").value = decodedText;
      stopScanner();
      scanQr(); 
    },
    (errorMessage) => { }
  ).catch(err => alert("Error de cÃ¡mara: " + err));
}

function stopScanner() {
  if (html5QrCode) {
    html5QrCode.stop().then(() => {
      document.getElementById("reader").classList.add("hidden");
    }).catch(() => {});
  }
}

async function createTicket() {
  const p = document.getElementById("placas").value;
  if (!p.trim()) return alert("Placas obligatorias");
  
  const info = { 
    placas: p, 
    marca: document.getElementById("marca").value, 
    modelo: document.getElementById("modelo").value, 
    color: document.getElementById("color").value 
  };
  
  try {
    const res = await fetch(API + "/ticket", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify(info)
    });
    const data = await res.json();
    enviarARawBT(data.id, info);
    limpiarNuevo();
  } catch(e) {
    alert("Error conectando con el servidor");
  }
}

async function scanQr() {
  const idBuscado = document.getElementById("qrId").value;
  if(!idBuscado) return;
  
  const res = await fetch(API + "/ticket/" + idBuscado);
  const data = await res.json();
  
  if (data.error) {
    document.getElementById("chargeInfo").innerHTML = `<p style="color:red;">${data.error}</p>`;
    document.getElementById("confirmArea").classList.add("hidden");
    return;
  }

  document.getElementById("chargeInfo").innerHTML = `
    <div style="margin-top:10px; border-top:2px solid #eee; padding-top:10px; font-size:20px;">
      <p><strong>Placa:</strong> ${data.placas}</p>
      <p><strong>Entrada:</strong> ${data.hora_entrada_cdmx}</p>
      <p>Total a pagar:</p>
      <div class="total">$${data.monto}.00</div>
    </div>
  `;
  document.getElementById("confirmArea").classList.remove("hidden");
}

async function confirmPayment() {
  const idBuscado = document.getElementById("qrId").value;
  if (!document.getElementById("confirmPaid").checked) return alert("Confirma el cobro.");
  
  await fetch(API + "/pay/" + idBuscado, { method:"POST" });
  alert("Â¡Pago registrado!");
  showPay();
}

function showNew() { document.getElementById("newTicket").classList.remove("hidden"); document.getElementById("payTicket").classList.add("hidden"); stopScanner(); }
function showPay() { document.getElementById("payTicket").classList.remove("hidden"); document.getElementById("newTicket").classList.add("hidden"); limpiarCobro(); }
function limpiarNuevo() { document.getElementById("placas").value=""; document.getElementById("marca").value=""; document.getElementById("modelo").value=""; document.getElementById("color").value=""; }
function limpiarCobro() { document.getElementById("qrId").value=""; document.getElementById("chargeInfo").innerHTML=""; document.getElementById("confirmPaid").checked=false; document.getElementById("confirmArea").classList.add("hidden"); stopScanner(); }
function toggleCorte() { document.getElementById("corteSection").classList.toggle("hidden"); }

async function obtenerCorte() {
  const res = await fetch(API + "/corte-caja", {
    method: "POST", headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ password: document.getElementById("adminPass").value })
  });
  const data = await res.json();
  if (res.status === 401) return alert("Clave Incorrecta");
  document.getElementById("corteResultado").innerHTML = `<p class="total">Hoy: $${data.total}.00</p><p>Boletos: ${data.boletos}</p>`;
}
</script>
</body>
</html>