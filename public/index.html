<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Estacionamiento Pro</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
  body { font-family: system-ui, sans-serif; background: linear-gradient(135deg, #1e3c72, #2a5298); margin: 0; padding: 20px; }
  .app { max-width: 420px; margin: auto; background: #fff; border-radius: 16px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
  h2 { text-align: center; color:#2a5298; }
  button { width: 100%; padding: 14px; margin: 10px 0; border-radius: 12px; border: none; font-size: 16px; cursor: pointer; font-weight: bold; }
  .primary { background:#2a5298; color:white; }
  .secondary { background:#f1f5f9; color: #1e3c72; }
  .success { background:#16a34a; color:white; }
  .warning { background:#fef08a; color: #854d0e; }
  input { width:100%; padding:12px; margin:6px 0; border-radius:10px; border:1px solid #ccc; box-sizing: border-box; font-size: 16px; }
  .card { background:#f8fafc; padding:15px; border-radius:12px; margin-top:15px; border: 1px solid #e2e8f0; }
  .hidden { display:none; }
  .total { font-size:28px; color:#16a34a; font-weight:bold; }
  #reader { width: 100%; border-radius: 12px; overflow: hidden; margin-top: 10px; }
</style>
</head>
<body>
<div class="app">
  <h2>ðŸš— Estacionamiento</h2>
  
  <button class="primary" onclick="showNew()">Nuevo boleto</button>
  <button class="secondary" onclick="showPay()">Cobrar Boleto</button>

  <div id="newTicket" class="card hidden">
    <input placeholder="Placas (Obligatorio)" id="placas">
    <input placeholder="Marca" id="marca">
    <input placeholder="Modelo" id="modelo">
    <input placeholder="Color" id="color">
    <button class="primary" onclick="createTicket()">Imprimir Ticket</button>
  </div>

  <div id="payTicket" class="card hidden">
    <button class="warning" onclick="startScanner()">ðŸ“· Escanear QR</button>
    <div id="reader" class="hidden"></div>
    <input placeholder="ID del Boleto" id="qrId">
    <button class="secondary" onclick="scanQr()">Buscar Datos</button>
    <div id="chargeInfo"></div>
    <div id="confirmArea" class="hidden">
      <label style="display:block; margin: 15px 0;"><input type="checkbox" id="confirmPaid"> Confirmar Pago</label>
      <button class="success" onclick="confirmPayment()">Finalizar Cobro</button>
    </div>
  </div>
</div>

<script>
const API = window.location.origin;
let html5QrCode;

function enviarARawBT(id, info) {
    const fechaActual = new Date().toLocaleString('es-MX', { 
        hour: '2-digit', minute: '2-digit', day: '2-digit', 
        month: '2-digit', year: 'numeric', hour12: true 
    });

    // 1. Crear un contenedor temporal para diseÃ±ar el ticket con HTML/CSS
    const ticketVirtual = document.createElement('div');
    ticketVirtual.style.width = '350px';
    ticketVirtual.style.padding = '10px';
    ticketVirtual.style.background = 'white';
    ticketVirtual.style.color = 'black';
    ticketVirtual.style.textAlign = 'center';
    ticketVirtual.style.fontFamily = 'monospace';

    ticketVirtual.innerHTML = `
        <h2 style="margin:0; font-size:24px;">ESTACIONAMIENTO</h2>
        <h3 style="margin:0; font-size:18px;">MORELOS 322</h3>
        <p style="margin:2px; font-size:14px;">Comalcalco, Tabasco</p>
        <p>--------------------------------</p>
        <p style="margin:0; font-size:16px;">PLACAS:</p>
        <h1 style="margin:5px 0; font-size:45px; font-weight:bold;">${info.placas.toUpperCase()}</h1>
        <p>--------------------------------</p>
        <div style="text-align:left; font-size:16px; font-weight:bold;">
            MARCA: ${info.marca || "---"}<br>
            MODELO: ${info.modelo || "---"}<br>
            COLOR: ${info.color || "---"}<br>
            ENTRADA: ${fechaActual}
        </div>
        <p>--------------------------------</p>
        <p style="font-weight:bold; margin:2px;">HORARIO: 8:30AM - 7:30PM</p>
        <p style="font-size:12px; margin:0;">No nos hacemos responsables por robo o daÃ±os.</p>
        <p style="font-weight:bold;">CONSERVE SU BOLETO</p>
        <p>--------------------------------</p>
        <div id="qr-dest" style="display:flex; justify-content:center; padding:10px;"></div>
        <br><br>
    `;

    // 2. AÃ±adirlo al body oculto para que el navegador lo renderice
    ticketVirtual.style.position = 'absolute';
    ticketVirtual.style.top = '-9999px';
    document.body.appendChild(ticketVirtual);

    // 3. Usar una librerÃ­a de QR simple o un texto si no quieres fallos
    // Para asegurar que salga ALGO ahora mismo, usaremos el ID en texto grande
    const qrDest = ticketVirtual.querySelector('#qr-dest');
    qrDest.innerHTML = `<b style="font-size:12px;">ID: ${id}</b>`;

    // 4. Convertir ese HTML en imagen usando una tÃ©cnica nativa (SVG ForeignObject)
    const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="350" height="650">
            <foreignObject width="100%" height="100%">
                <div xmlns="http://www.w3.org/1999/xhtml">
                    ${ticketVirtual.innerHTML}
                </div>
            </foreignObject>
        </svg>
    `;

    const base64Image = btoa(unescape(encodeURIComponent(svg)));
    
    // 5. Enviar a RawBT (Cambiamos el esquema para forzar la app)
    const rawbtUrl = "rawbt:data:image/svg+xml;base64," + base64Image;
    
    window.location.href = rawbtUrl;

    // Limpiar
    document.body.removeChild(ticketVirtual);
}

// FUNCIONES RESTANTES (Sin cambios)
async function createTicket() {
  const p = document.getElementById("placas").value;
  if (!p.trim()) return alert("Placas obligatorias");
  const info = { placas: p, marca: document.getElementById("marca").value, modelo: document.getElementById("modelo").value, color: document.getElementById("color").value };
  try {
    const res = await fetch(API + "/ticket", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(info) });
    const data = await res.json();
    enviarARawBT(data.id, info);
    document.getElementById("placas").value="";
    document.getElementById("marca").value="";
    document.getElementById("modelo").value="";
    document.getElementById("color").value="";
  } catch(e) { alert("Error al conectar"); }
}

function startScanner() {
  document.getElementById("reader").classList.remove("hidden");
  html5QrCode = new Html5Qrcode("reader");
  html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: 250 }, (text) => {
      document.getElementById("qrId").value = text;
      stopScanner();
      scanQr(); 
  }).catch(e => alert(e));
}

function stopScanner() { if (html5QrCode) html5QrCode.stop().then(() => document.getElementById("reader").classList.add("hidden")); }

async function scanQr() {
  const id = document.getElementById("qrId").value;
  if(!id) return;
  const res = await fetch(API + "/ticket/" + id);
  const data = await res.json();
  if (data.error) { document.getElementById("chargeInfo").innerHTML = `<p style="color:red;">${data.error}</p>`; return; }
  document.getElementById("chargeInfo").innerHTML = `<div class="card"><p>Placa: <b>${data.placas}</b></p><p class="total">$${data.monto}.00</p></div>`;
  document.getElementById("confirmArea").classList.remove("hidden");
}

async function confirmPayment() {
  if (!document.getElementById("confirmPaid").checked) return alert("Confirma el cobro");
  await fetch(API + "/pay/" + document.getElementById("qrId").value, { method:"POST" });
  alert("Pago registrado correctamente");
  showPay();
}

function showNew() { document.getElementById("newTicket").classList.remove("hidden"); document.getElementById("payTicket").classList.add("hidden"); }
function showPay() { document.getElementById("payTicket").classList.remove("hidden"); document.getElementById("newTicket").classList.add("hidden"); }
</script>
</body>
</html>